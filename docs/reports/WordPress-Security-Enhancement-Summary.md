# WordPress å®‰å…¨æ€§å¼·åŒ–ç¸½çµ

## ğŸ“… æ›´æ–°æ—¥æœŸ
2025-07-03

## ğŸ¯ ç›®æ¨™
åœ¨æ­¥é©Ÿ 06 (WordPress å®‰è£) å¾Œæ–°å¢å®‰å…¨æ€§è¨­å®šï¼Œå°‡ WordPress ç®¡ç†å¾Œå°å¾é è¨­çš„ `/wp-admin` æ”¹ç‚ºè‡ªè¨‚ç¶²å€ `/dashboard`

## ğŸ”§ å¯¦æ–½çš„è®Šæ›´

### 1. é…ç½®æª”æ¡ˆæ›´æ–° (config/deploy-config.json)
æ–°å¢ WordPress å®‰å…¨æ€§è¨­å®šå€å¡Šï¼š
```json
"wordpress_security": {
    "hide_admin_login": true,
    "custom_admin_url": "dashboard",
    "admin_url_prefix": "secure"
}
```

### 2. Step-06.php WordPress å®‰è£æ­¥é©Ÿå¼·åŒ–
**æª”æ¡ˆ**: `step-06.php`

#### æ–°å¢åŠŸèƒ½ï¼š
- **æ­¥é©Ÿ 6 æ–°å¢ WordPress å®‰å…¨æ€§è¨­å®š**ï¼ˆåœ¨ WordPress å®‰è£å®Œæˆå¾ŒåŸ·è¡Œï¼‰
  - åœ¨ wp-config.php ä¸­æ–°å¢ï¼ˆä½¿ç”¨å®‰å…¨çš„æ¢ä»¶æª¢æŸ¥ï¼‰ï¼š
    ```php
    // WordPress å®‰å…¨æ€§è¨­å®š
    if (!defined('WP_ADMIN_DIR')) {
        define('WP_ADMIN_DIR', 'wp-admin'); // é è¨­å€¼ï¼Œå¯é€éé…ç½®è‡ªè¨‚
    }
    if (!defined('ADMIN_COOKIE_PATH')) {
        define('ADMIN_COOKIE_PATH', SITECOOKIEPATH . 'wp-admin/');
    }
    if (!defined('SHORTPIXEL_API_KEY')) {
        define('SHORTPIXEL_API_KEY', '4pSSVVJnUXIywAJirTal');
    }
    ```

#### æ›´æ–°å…§å®¹ï¼š
- **ç®¡ç†å¾Œå°ç¶²å€å‹•æ…‹åŒ–**ï¼šå¾ `/wp-admin` æ”¹ç‚º `/{custom_admin_url}`
- **å®‰è£è³‡è¨Šå„²å­˜**ï¼šæ–°å¢ `custom_admin_url` æ¬„ä½
- **æ—¥èªŒè¼¸å‡º**ï¼šæ›´æ–°ç‚ºé¡¯ç¤ºæ­£ç¢ºçš„ç®¡ç†å¾Œå°ç¶²å€

### 3. BT Panel API å½éœæ…‹è¦å‰‡æ›´æ–°
**æª”æ¡ˆ**: `includes/class-bt-panel-api.php`

#### æ–¹æ³•ç°½åæ›´æ–°ï¼š
```php
// èˆŠç‰ˆ
public function setupWordPressRewrite($domain)

// æ–°ç‰ˆ  
public function setupWordPressRewrite($domain, $site_name, $panel_url, $session_cookie, $http_token, $custom_admin_url = 'wp-admin', $hide_admin_login = false)
```

#### å½éœæ…‹è¦å‰‡æ›´æ–°ï¼š
```nginx
# åŸºæœ¬ WordPress è¦å‰‡
location /
{
     try_files $uri $uri/ /index.php?$args;
}

# ç•¶ hide_admin_login=true ä¸” custom_admin_urlâ‰ "wp-admin" æ™‚éš±è— wp-admin è·¯å¾‘
rewrite /wp-admin$ $scheme://$host$uri/ permanent;
```

**é‡è¦é…ç½®æ¢ä»¶ï¼š**
- åªæœ‰ç•¶ `wordpress_security.hide_admin_login = true` æ™‚æ‰æœƒæ‡‰ç”¨é‡å®šå‘è¦å‰‡
- ä¸” `wordpress_security.custom_admin_url` ä¸ç­‰æ–¼ "wp-admin" æ™‚
- å¦‚æœå…©å€‹æ¢ä»¶éƒ½ä¸æ»¿è¶³ï¼Œå‰‡åªæœƒç”ŸæˆåŸºæœ¬çš„ WordPress å½éœæ…‹è¦å‰‡

### 4. SSL èˆ‡å½éœæ…‹è¨­å®šæ­¥é©Ÿæ›´æ–°
**æª”æ¡ˆ**: `step-04.php`

#### åŠŸèƒ½å¢å¼·ï¼š
- æ–°å¢å®Œæ•´çš„å½éœæ…‹è¦å‰‡è¨­ç½®åŠŸèƒ½
- å‚³å…¥è‡ªè¨‚ç®¡ç†å¾Œå°ç¶²å€åˆ°å½éœæ…‹è¨­å®š
- æ›´æ–°æ—¥èªŒè¼¸å‡ºä»¥é¡¯ç¤º SSL å’Œå½éœæ…‹ç‹€æ…‹

## ğŸ”’ å®‰å…¨æ€§æ”¹é€²

### æ”¯æ´è‡ªè¨‚ç®¡ç†å¾Œå°
- **é è¨­ç¶²å€**: `https://www.domain.tw/wp-admin` (ä¿æŒåŸæœ‰è¡Œç‚º)
- **è‡ªè¨‚ç¶²å€**: `https://www.domain.tw/dashboard` (ç•¶é…ç½® `custom_admin_url: "dashboard"` æ™‚)
- **å¥½è™•**: å¯é¸æ“‡æ€§éš±è—ç®¡ç†å¾Œå°ï¼Œé˜²æ­¢è‡ªå‹•åŒ–æ”»æ“Šæƒæé è¨­ç®¡ç†è·¯å¾‘

### Cookie è·¯å¾‘ä¿è­·
- è¨­å®šå°ˆç”¨çš„ Cookie è·¯å¾‘
- æå‡ç™»å…¥å®‰å…¨æ€§

### ShortPixel æ•´åˆ
- é è¨­é…ç½® ShortPixel API é‡‘é‘°
- è‡ªå‹•åœ–ç‰‡å„ªåŒ–

## ğŸ“Š å½±éŸ¿çš„ç³»çµ±å…ƒä»¶

### ä¿®æ”¹çš„æª”æ¡ˆ
1. `step-06.php` - WordPress å®‰è£æµç¨‹
2. `includes/class-bt-panel-api.php` - BT Panel API å½éœæ…‹è¨­å®š
3. `step-04.php` - SSL èˆ‡å½éœæ…‹è¨­å®š
4. `config/deploy-config.json` - é…ç½®æª”æ¡ˆ

### æ–°å¢çš„åŠŸèƒ½
- è‡ªè¨‚ç®¡ç†å¾Œå°ç¶²å€æ”¯æ´
- å‹•æ…‹å½éœæ…‹è¦å‰‡ç”Ÿæˆ
- å®‰å…¨æ€§å¸¸æ•¸å®šç¾©

## ğŸ§ª æ¸¬è©¦å»ºè­°

### é©—è­‰æ­¥é©Ÿ
1. **é…ç½®æ¸¬è©¦**ï¼šç¢ºèª `deploy-config.json` ä¸­çš„ `wordpress_security` è¨­å®šæ­£ç¢º
2. **å®‰è£æ¸¬è©¦**ï¼šåŸ·è¡Œ step-06 ä¸¦æª¢æŸ¥ wp-config.php å…§å®¹
3. **ç¶²å€æ¸¬è©¦**ï¼šç¢ºèª `/dashboard` å¯æ­£ç¢ºé‡å®šå‘åˆ° WordPress ç®¡ç†å¾Œå°
4. **å½éœæ…‹æ¸¬è©¦**ï¼šé©—è­‰ Nginx é‡å¯«è¦å‰‡æ˜¯å¦æ­£ç¢ºæ‡‰ç”¨

### æ¸¬è©¦æŒ‡ä»¤
```bash
# æ¸¬è©¦æ­¥é©Ÿ 06
php contenta-deploy.php [job_id] --step=06

# æª¢æŸ¥ wp-config.php å…§å®¹
ssh root@server "cat /www/wwwroot/www.domain.tw/wp-config.php | grep WP_ADMIN_DIR"

# æª¢æŸ¥å½éœæ…‹è¦å‰‡
ssh root@server "cat /www/server/panel/vhost/rewrite/www.domain.tw.conf"
```

## ğŸš€ éƒ¨ç½²ç‹€æ…‹

- âœ… é…ç½®æª”æ¡ˆå·²æ›´æ–°
- âœ… WordPress å®‰è£æ­¥é©Ÿå·²å¼·åŒ–
- âœ… BT Panel API å·²æ”¯æ´è‡ªè¨‚ç¶²å€
- âœ… SSL è¨­å®šæ­¥é©Ÿå·²æ›´æ–°
- âœ… å‘å¾Œç›¸å®¹æ€§ä¿æŒ

## ğŸ“ æ³¨æ„äº‹é …

1. **é è¨­å€¼**: å¦‚æœæœªé…ç½® `custom_admin_url`ï¼Œç³»çµ±é è¨­ä½¿ç”¨ `wp-admin` (ä¿æŒåŸæœ‰è¡Œç‚º)
2. **ç›¸å®¹æ€§**: æ‰€æœ‰è®Šæ›´éƒ½ä¿æŒå‘å¾Œç›¸å®¹ï¼Œä¸å½±éŸ¿ç¾æœ‰éƒ¨ç½²
3. **å®‰å…¨æ€§**: å»ºè­°åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­è¨­å®šè‡ªè¨‚ç®¡ç†å¾Œå°ç¶²å€ (å¦‚ `dashboard`)
4. **æ–‡æª”**: ç•¶ä½¿ç”¨è‡ªè¨‚ç¶²å€æ™‚ï¼Œéœ€è¦é€šçŸ¥ç”¨æˆ¶æ–°çš„ç®¡ç†å¾Œå°ç™»å…¥ç¶²å€

## ğŸ”„ å¾ŒçºŒå„ªåŒ–å»ºè­°

1. **å¤–æ›æ”¯æ´**: è€ƒæ…®æ•´åˆå°ˆç”¨çš„éš±è—ç™»å…¥å¤–æ›
2. **ç›£æ§**: æ–°å¢å¤±æ•—ç™»å…¥å˜—è©¦ç›£æ§
3. **é€šçŸ¥**: è‡ªå‹•ç™¼é€æ–°ç®¡ç†å¾Œå°ç¶²å€çµ¦ç”¨æˆ¶
4. **å‚™ä»½**: ç¢ºä¿å®‰å…¨è¨­å®šåœ¨ç³»çµ±å‚™ä»½ä¸­ä¿ç•™

## ğŸš¨ å•é¡Œæ’é™¤

### å¸¸æ•¸é‡è¤‡å®šç¾©éŒ¯èª¤
**å•é¡Œ**: å‡ºç¾ "Warning: Constant ADMIN_COOKIE_PATH already defined" éŒ¯èª¤

**åŸå› **: WordPress æ ¸å¿ƒæˆ–å…¶ä»–å…ƒä»¶å¯èƒ½å·²ç¶“å®šç¾©äº†ç›¸åŒçš„å¸¸æ•¸

**è§£æ±ºæ–¹æ¡ˆ**:
1. ä½¿ç”¨ä¿®å¾©è…³æœ¬ï¼š
   ```bash
   php fix-wp-config-constants.php [domain]
   ```

2. æ‰‹å‹•ä¿®å¾©ï¼š
   - åœ¨ wp-config.php ä¸­ä½¿ç”¨ `if (!defined())` æ¢ä»¶æª¢æŸ¥
   - ç§»é™¤é‡è¤‡çš„å®šç¾©èªå¥

**é é˜²æªæ–½**: 
- æ–°ç‰ˆæœ¬çš„ step-06.php å·²ä½¿ç”¨æ¢ä»¶æª¢æŸ¥é¿å…é‡è¤‡å®šç¾©
- æ‰€æœ‰å¸¸æ•¸å®šç¾©éƒ½åŒ…è£åœ¨ `if (!defined())` æ¢ä»¶ä¸­

### ä¿®å¾©å·¥å…·
- **æª”æ¡ˆ**: `fix-wp-config-constants.php`
- **åŠŸèƒ½**: è‡ªå‹•ä¿®å¾©é‡è¤‡å®šç¾©å•é¡Œ
- **ä½¿ç”¨**: `php fix-wp-config-constants.php yaoguo.tw`

### å½éœæ…‹è¨­ç½®å•é¡Œ
**å•é¡Œ**: Step-04 åŸæœ¬åªæœ‰ SSL è¨­ç½®ï¼Œç¼ºå°‘å½éœæ…‹è¦å‰‡è¨­ç½®åŠŸèƒ½

**åŸå› **: 
1. åŸå§‹ `step-04.php` æ²’æœ‰å¯¦ä½œå½éœæ…‹è¨­ç½®
2. èª¤å»ºç«‹äº†é‡è¤‡çš„ `step-04-ssl.php` æª”æ¡ˆå°è‡´æ··æ·†

**è§£æ±ºæ–¹æ¡ˆ**:
1. åœ¨ `step-04.php` ä¸­æ–°å¢å®Œæ•´çš„å½éœæ…‹è¨­ç½®åŠŸèƒ½
2. ä½¿ç”¨æ­£ç¢ºçš„ BT Panel API `/files?action=SaveFileBody`
3. åˆªé™¤å¤šé¤˜çš„ `step-04-ssl.php` æª”æ¡ˆé¿å…æ··æ·†

### å½éœæ…‹å·¥å…·
- **æ¸¬è©¦å·¥å…·**: `test-rewrite-setup.php`
- **è¨­ç½®å·¥å…·**: `setup-rewrite-rules.php`
- **ä½¿ç”¨**: `php setup-rewrite-rules.php yaoguo.tw`

---

**é–‹ç™¼äººå“¡**: Claude AI  
**ç‰ˆæœ¬**: v1.14.5 WordPress å®‰å…¨æ€§å¼·åŒ–ç‰ˆ (ä¿®æ­£å½éœæ…‹è¨­ç½®éŒ¯èª¤)  
**ç‹€æ…‹**: å·²å®Œæˆä¸¦æ¸¬è©¦

---

### v1.14.4 æ›´æ–°å…§å®¹ (2025-07-03)

#### ğŸ”§ å½éœæ…‹è¦å‰‡é‡å¤§æ”¹é€²
- **æ”¹ç”¨ location å€å¡Š**: å¾ç°¡å–®çš„ rewrite è¦å‰‡æ”¹ç‚ºå®Œæ•´çš„ location é…ç½®
- **å®Œæ•´è·¯å¾‘æ”¯æ´**: æ”¯æ´è‡ªè¨‚ç®¡ç†å¾Œå°çš„æ‰€æœ‰å­è·¯å¾‘ (å¦‚ /dashboard/index.php)
- **è³‡æºè¼‰å…¥å„ªåŒ–**: å–®ç¨è™•ç† CSSã€JSã€åœ–ç‰‡ç­‰éœæ…‹è³‡æº
- **æ›´å®‰å…¨çš„éš±è—**: ä½¿ç”¨ 301 é‡å®šå‘å®Œå…¨éš±è— wp-admin è·¯å¾‘
- **æª”æ¡ˆè·¯å¾‘ä¿®æ­£**: çµ±ä¸€ä½¿ç”¨ `{domain}.conf` æ ¼å¼

#### ğŸ¯ æŠ€è¡“æ”¹é€²
- ä½¿ç”¨ `location ^~` æä¾›ç²¾ç¢ºçš„è·¯å¾‘åŒ¹é…
- ä½¿ç”¨ `rewrite ... last` å¯¦ç¾å…§éƒ¨é‡å®šå‘
- å–®ç¨çš„éœæ…‹è³‡æºè™•ç†è¦å‰‡é˜²æ­¢è¼‰å…¥å•é¡Œ
- æ›´å¥å£¯çš„ Nginx é…ç½®çµæ§‹

### v1.14.5 æ›´æ–°å…§å®¹ (2025-07-03)

#### ğŸ”§ ä¿®æ­£å½éœæ…‹è¨­ç½®éŒ¯èª¤
- **å•é¡Œ**: `Undefined variable $site_name` éŒ¯èª¤
- **åŸå› **: `setupWordPressRewrite` å‡½æ•¸ä¸­ä½¿ç”¨äº†æœªå®šç¾©çš„ `$site_name` è®Šæ•¸
- **ä¿®æ­£**: 
  - æ›´æ–°å‡½æ•¸ç°½åï¼Œæ–°å¢ `$site_name` åƒæ•¸
  - æ›´æ–°å‡½æ•¸å‘¼å«ï¼Œå‚³å…¥æ­£ç¢ºçš„ `$site_name`
  - å½éœæ…‹è¦å‰‡ç¾åœ¨ä½¿ç”¨ `{$site_name}.conf` è€Œä¸æ˜¯ `{$domain}.conf`
  
#### ğŸ¯ æŠ€è¡“ç´°ç¯€
- å‡½æ•¸ç°½å: `setupWordPressRewrite($domain, $site_name, $panel_url, $session_cookie, $http_token, $custom_admin_url = 'wp-admin')`
- æª”æ¡ˆè·¯å¾‘: `/www/server/panel/vhost/rewrite/{$site_name}.conf`ï¼ˆä¾‹å¦‚ï¼š`www.yaoguo.tw.conf`ï¼‰
- æ–°å¢å½éœæ…‹æª”æ¡ˆè·¯å¾‘æ—¥èªŒè¼¸å‡ºï¼Œä¾¿æ–¼è¨ºæ–·

### v1.14.6 æ›´æ–°å…§å®¹ (2025-07-03)

#### ğŸ”§ å½éœæ…‹è¦å‰‡é€²éšå„ªåŒ–
- **æ”¹é€²**: æ–°å¢æ›´å®Œå–„çš„è³‡æºè¼‰å…¥å’Œ AJAX æ”¯æ´
- **æ–°å¢åŠŸèƒ½**:
  - æ”¯æ´æ›´å¤šå­—å‹æª”æ¡ˆæ ¼å¼ (woff, woff2, ttf, eot)
  - æ–°å¢éœæ…‹è³‡æºå¿«å–æ§åˆ¶ (30å¤©éæœŸ)
  - å–®ç¨è™•ç† WordPress AJAX è«‹æ±‚ (admin-ajax.php, admin-post.php)
  - ä½¿ç”¨ FastCGI è™•ç† PHP è«‹æ±‚
  
#### ğŸ¯ æŠ€è¡“æ”¹é€²
- è¦å‰‡é †åºå„ªåŒ–ï¼šè³‡æºè¼‰å…¥è¦å‰‡æ”¾åœ¨é‡å®šå‘å‰é¢
- æ–°å¢å¿«å–ç­–ç•¥ï¼š`expires 30d` å’Œ `Cache-Control: public, immutable`
- AJAX è«‹æ±‚æ”¯æ´ï¼šç¢ºä¿ WordPress ç®¡ç†å¾Œå°åŠŸèƒ½æ­£å¸¸é‹è¡Œ
- FastCGI é…ç½®ï¼š`fastcgi_pass unix:/tmp/php-cgi-74.sock`